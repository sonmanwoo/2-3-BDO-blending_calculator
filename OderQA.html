<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>제품 품질 평가 기록지</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.28.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, onSnapshot, orderBy, where, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: These global variables are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        setLogLevel('debug');
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let unsubscribeEvaluations = null;
        let unsubscribeApprovals = null;
        let selectedSampleCode = 'all';
        let allEvaluations = [];
        let allSampleData = {};
        let allApprovals = {};
        let selectedEvaluation = null;
        let selectedApproval = null;
        let currentApprovalRole = null;
        
        const evaluatorPage = document.getElementById('evaluator-page');
        const adminPage = document.getElementById('admin-page');
        const evaluatorNav = document.getElementById('nav-evaluator');
        const adminNav = document.getElementById('nav-admin');

        const evaluationForm = document.getElementById('evaluation-form');
        const evaluationTableBody = document.getElementById('evaluation-table-body');
        const visualDataSection = document.getElementById('visual-data');
        const odorIntensityRadios = document.querySelectorAll('input[name="odor-intensity"]');
        const finalEvaluationDisplay = document.getElementById('final-evaluation-display');
        const sampleCodeFilter = document.getElementById('sample-code-filter');
        const messageBox = document.getElementById('message-box');

        // Confirmation Modal elements
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');
        
        // Approval section elements
        const approvalSection = document.getElementById('approval-section');
        const approvalSampleCode = document.getElementById('approval-sample-code');
        const approvalFinalStatus = document.getElementById('approval-final-status');
        const approvalButtons = document.getElementById('approval-buttons');
        const roleSelect = document.getElementById('role-select');
        const downloadPdfButton = document.getElementById('download-pdf-button');

        // Approval Modal elements
        const approvalModal = document.getElementById('approval-modal');
        const signatureCanvas = document.getElementById('signature-canvas');
        const ctx = signatureCanvas.getContext('2d');
        const signatureNameInput = document.getElementById('signature-name');
        const signatureSaveBtn = document.getElementById('signature-save-btn');
        const signatureClearBtn = document.getElementById('signature-clear-btn');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const currentRoleDisplay = document.getElementById('current-role-display');
        
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        
        // Define roles and their names
        const managerRoles = ['production', 'process', 'sales', 'quality_control'];
        const managerNames = {
            production: '생산 담당자',
            process: '공정 담당자',
            sales: '판매 담당자',
            quality_control: '품질관리 책임자'
        };
        const allRoles = ['production', 'process', 'sales', 'quality_control'];
        
        // Signature Canvas functionality
        signatureCanvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            const rect = signatureCanvas.getBoundingClientRect();
            [lastX, lastY] = [e.clientX - rect.left, e.clientY - rect.top];
        });
        signatureCanvas.addEventListener('mousemove', draw);
        signatureCanvas.addEventListener('mouseup', () => isDrawing = false);
        signatureCanvas.addEventListener('mouseout', () => isDrawing = false);
        
        // Touch events for mobile
        signatureCanvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = signatureCanvas.getBoundingClientRect();
            const touch = e.touches[0];
            isDrawing = true;
            [lastX, lastY] = [touch.clientX - rect.left, touch.clientY - rect.top];
        }, false);
        signatureCanvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            draw(e.touches[0]);
        }, false);
        signatureCanvas.addEventListener('touchend', () => isDrawing = false, false);
        signatureCanvas.addEventListener('touchcancel', () => isDrawing = false, false);

        function draw(e) {
            if (!isDrawing) return;
            const rect = signatureCanvas.getBoundingClientRect();
            let currentX, currentY;
            if (e.clientX && e.clientY) {
                currentX = e.clientX - rect.left;
                currentY = e.clientY - rect.top;
            } else if (e.touches && e.touches[0]) {
                const touch = e.touches[0];
                currentX = touch.clientX - rect.left;
                currentY = touch.clientY - rect.top;
            } else {
                return;
            }
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.stroke();
            [lastX, lastY] = [currentX, currentY];
        }

        signatureClearBtn.addEventListener('click', () => {
            ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        });

        // Show a temporary message
        function showMessage(message, isSuccess = true) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
            messageBox.classList.add(isSuccess ? 'bg-green-500' : 'bg-red-500');
            messageBox.classList.add('animate-fadeIn');

            setTimeout(() => {
                messageBox.classList.remove('animate-fadeIn');
                messageBox.classList.add('animate-fadeOut');
                messageBox.addEventListener('animationend', () => {
                    messageBox.classList.remove('animate-fadeOut');
                    messageBox.classList.add('hidden');
                }, { once: true });
            }, 3000);
        }

        // Show confirmation modal
        function showConfirmModal(message, onYes, onNo) {
            confirmMessage.textContent = message;
            confirmModal.classList.remove('hidden');
            
            confirmYesBtn.onclick = () => {
                confirmModal.classList.add('hidden');
                onYes();
            };
            confirmNoBtn.onclick = () => {
                confirmModal.classList.add('hidden');
                onNo();
            };
        }

        // Page switching logic
        function showPage(pageName) {
            if (pageName === 'evaluator') {
                evaluatorPage.classList.remove('hidden');
                adminPage.classList.add('hidden');
                evaluatorNav.classList.add('bg-gray-200');
                adminNav.classList.remove('bg-gray-200');
            } else {
                evaluatorPage.classList.add('hidden');
                adminPage.classList.remove('hidden');
                evaluatorNav.classList.remove('bg-gray-200');
                adminNav.classList.add('bg-gray-200');
                // Re-render admin page content when it's shown
                updateAdminUI();
            }
        }

        evaluatorNav.addEventListener('click', () => showPage('evaluator'));
        adminNav.addEventListener('click', () => showPage('admin'));
        showPage('evaluator'); // Show evaluator page by default

        // Authenticate and set up Firestore listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("Authenticated with user ID:", userId);
                document.getElementById('user-id').textContent = userId;
                setupFirestoreListeners();
            } else {
                console.log("No user signed in. Signing in anonymously...");
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Anonymous sign-in failed:", error);
                    showMessage("인증에 실패했습니다. 다시 시도해주세요.", false);
                }
            }
        });

        // Set up real-time listeners for evaluations and approvals
        function setupFirestoreListeners() {
            if (unsubscribeEvaluations) { unsubscribeEvaluations(); }
            if (unsubscribeApprovals) { unsubscribeApprovals(); }
            
            // Listener for evaluations
            const evaluationsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/evaluations`);
            unsubscribeEvaluations = onSnapshot(query(evaluationsCollectionRef, orderBy('timestamp', 'desc')), (querySnapshot) => {
                const evaluations = [];
                const sampleData = {};
                const uniqueSampleCodes = new Set();
                uniqueSampleCodes.add('all');

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    evaluations.push({ id: doc.id, ...data });

                    if (!sampleData[data.sampleCode]) {
                        sampleData[data.sampleCode] = [];
                    }
                    sampleData[data.sampleCode].push(data);
                    uniqueSampleCodes.add(data.sampleCode);
                });

                allEvaluations = evaluations;
                allSampleData = sampleData;
                populateSampleCodeFilter(Array.from(uniqueSampleCodes));
                updateAdminUI();
            }, (error) => {
                console.error("Failed to fetch evaluation data:", error);
                showMessage("평가 데이터를 불러오는 데 실패했습니다.", false);
            });
            
            // Listener for approvals
            const approvalsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/approvals`);
            unsubscribeApprovals = onSnapshot(approvalsCollectionRef, (querySnapshot) => {
                const approvals = {};
                querySnapshot.forEach(doc => {
                    approvals[doc.id] = doc.data();
                });
                allApprovals = approvals;
                updateAdminUI();
            }, (error) => {
                console.error("Failed to fetch approval data:", error);
                showMessage("승인 데이터를 불러오는 데 실패했습니다.", false);
            });
        }
        
        // Function to update the admin page UI
        function updateAdminUI() {
            const filteredEvaluations = allEvaluations.filter(item => selectedSampleCode === 'all' || item.sampleCode === selectedSampleCode);
            renderTable(filteredEvaluations);
            renderBoxPlot(allSampleData);
            
            selectedApproval = allApprovals[selectedSampleCode] || null;

            if (selectedSampleCode !== 'all' && allSampleData[selectedSampleCode]) {
                const odorScores = allSampleData[selectedSampleCode].map(e => parseFloat(e.odorIntensity)).filter(v => !isNaN(v));
                const averageScore = odorScores.length > 0 ? (odorScores.reduce((sum, score) => sum + score, 0) / odorScores.length) : 0;
                const finalStatus = averageScore >= 9.5 ? 'Pass' : 'Non-Pass';
                
                selectedEvaluation = {
                    ...allSampleData[selectedSampleCode][0],
                    evaluations: allSampleData[selectedSampleCode],
                    finalEvaluation: finalStatus,
                    averageScore: averageScore
                };
            } else {
                selectedEvaluation = null;
            }

            renderApprovalSection();
        }

        function populateSampleCodeFilter(sampleCodes) {
            sampleCodeFilter.innerHTML = '';
            sampleCodes.sort().forEach(code => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = code === 'all' ? '전체 시료' : code;
                sampleCodeFilter.appendChild(option);
            });
            sampleCodeFilter.value = selectedSampleCode;
        }

        sampleCodeFilter.addEventListener('change', (e) => {
            selectedSampleCode = e.target.value;
            updateAdminUI();
        });
        
        // Render the approval section UI based on the selected sample
        function renderApprovalSection() {
            if (selectedSampleCode === 'all' || !selectedEvaluation) {
                approvalSection.classList.add('hidden');
                return;
            }
            
            approvalSection.classList.remove('hidden');
            approvalSampleCode.textContent = selectedEvaluation.sampleCode;
            const finalStatus = selectedEvaluation.finalEvaluation;
            approvalFinalStatus.textContent = finalStatus;
            approvalFinalStatus.className = `font-semibold ${finalStatus === 'Pass' ? 'text-green-600' : 'text-red-600'}`;

            const approvals = selectedApproval ? selectedApproval.approvals : {};
            
            let approvedCount = 0;
            if (approvals.production) approvedCount++;
            if (approvals.process) approvedCount++;
            if (approvals.sales) approvedCount++;
            
            approvalButtons.innerHTML = '';
            
            const isQualityControlApproved = !!approvals.quality_control;
            if (isQualityControlApproved) {
                downloadPdfButton.classList.remove('hidden');
            } else {
                downloadPdfButton.classList.add('hidden');
            }

            allRoles.forEach(role => {
                const approval = approvals[role];
                const isApproved = !!approval;
                let isEnabled = false;
                
                if (role === 'quality_control') {
                    isEnabled = !isApproved && approvedCount >= 2;
                } else {
                    isEnabled = !isApproved;
                }
                
                const btn = document.createElement('div');
                btn.className = `flex flex-col items-center p-4 rounded-lg transition-colors ${isApproved ? 'bg-green-100 border border-green-300' : 'bg-gray-100 border border-gray-300'}`;
                
                if (isApproved) {
                    btn.innerHTML = `
                        <span class="text-sm font-semibold">${managerNames[role]}</span>
                        <p class="text-xs text-gray-500 mt-1">승인됨</p>
                        <p class="text-xs text-gray-500">${approval.name}</p>
                        <p class="text-xs text-gray-400 mt-1">${approval.date}</p>
                        <img src="${approval.signature}" alt="전자서명" class="w-16 h-8 mt-2">
                    `;
                } else {
                    btn.innerHTML = `
                        <span class="text-sm font-semibold">${managerNames[role]}</span>
                        <button class="mt-2 px-4 py-1 text-sm rounded-md transition-colors ${isEnabled ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-gray-400 text-gray-700 cursor-not-allowed'}" ${!isEnabled ? 'disabled' : ''} onclick="openApprovalModal('${role}')">
                            승인하기
                        </button>
                    `;
                }
                approvalButtons.appendChild(btn);
            });
        }
        
        // Open modal for approval
        window.openApprovalModal = (role) => {
            currentApprovalRole = role;
            currentRoleDisplay.textContent = managerNames[role];
            ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            signatureNameInput.value = '';
            approvalModal.classList.remove('hidden');
            
            // Re-check approval status on modal open
            const approvals = selectedApproval ? selectedApproval.approvals : {};
            const approvedCount = ['production', 'process', 'sales'].filter(r => approvals[r]).length;
            const isQualityControlReady = approvedCount >= 2;
            
            if (role === 'quality_control' && !isQualityControlReady) {
                showMessage("품질관리 책임자는 다른 담당자 2명 이상이 승인해야 승인할 수 있습니다.", false);
                approvalModal.classList.add('hidden');
                return;
            }
        };

        // Close modal
        modalCloseBtn.addEventListener('click', () => {
            approvalModal.classList.add('hidden');
        });

        // Save approval and update Firestore
        signatureSaveBtn.addEventListener('click', async () => {
            if (!selectedSampleCode || selectedSampleCode === 'all') {
                showMessage("승인을 위한 시료가 선택되지 않았습니다. 시료를 먼저 선택해주세요.", false);
                approvalModal.classList.add('hidden');
                return;
            }
            if (!currentApprovalRole) {
                showMessage("승인 역할을 찾을 수 없습니다. 다시 시도해주세요.", false);
                approvalModal.classList.add('hidden');
                return;
            }

            const signatureData = signatureCanvas.toDataURL();
            const userName = signatureNameInput.value.trim();
            const approvalDate = new Date().toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });

            const emptyCanvasData = document.createElement('canvas');
            emptyCanvasData.width = signatureCanvas.width;
            emptyCanvasData.height = signatureCanvas.height;
            const emptyDataUrl = emptyCanvasData.toDataURL();

            if (!userName || signatureData === emptyDataUrl) {
                showMessage("이름과 서명을 모두 입력해주세요.", false);
                return;
            }
            
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/approvals`, selectedSampleCode);
                
                await setDoc(docRef, {
                    approvals: {
                        [currentApprovalRole]: {
                            name: userName,
                            date: approvalDate,
                            signature: signatureData
                        }
                    }
                }, { merge: true });
                
                showMessage("승인이 성공적으로 완료되었습니다.");
                approvalModal.classList.add('hidden');
            } catch (error) {
                console.error("Error saving approval:", error);
                showMessage("승인 기록 저장에 실패했습니다.", false);
            }
        });


        // Render evaluation data in the table
        function renderTable(evaluations) {
            evaluationTableBody.innerHTML = '';
            evaluations.forEach(evalItem => {
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-100 transition-colors";
                const finalEvaluation = evalItem.finalEvaluation || (parseFloat(evalItem.odorIntensity) >= 9.5 ? 'Pass' : 'Non-Pass');
                row.innerHTML = `
                    <td class="p-4 border-b border-gray-200">${evalItem.evalDate}</td>
                    <td class="p-4 border-b border-gray-200">${evalItem.evalPlace}</td>
                    <td class="p-4 border-b border-gray-200">${evalItem.sampleCode}</td>
                    <td class="p-4 border-b border-gray-200">${evalItem.evaluator}</td>
                    <td class="p-4 border-b border-gray-200">${evalItem.odorIntensity}</td>
                    <td class="p-4 border-b border-gray-200">${evalItem.odorCharacteristic}</td>
                    <td class="p-4 border-b border-gray-200">${evalItem.pleasantness}</td>
                    <td class="p-4 border-b border-gray-200">${evalItem.remarks}</td>
                    <td class="p-4 border-b border-gray-200 ${finalEvaluation === 'Pass' ? 'text-green-600' : 'text-red-600'} font-semibold">${finalEvaluation}</td>
                    <td class="p-4 border-b border-gray-200">
                        <button onclick="deleteEvaluation('${evalItem.id}')" class="text-red-500 hover:text-red-700 transition-colors">삭제</button>
                    </td>
                `;
                evaluationTableBody.appendChild(row);
            });
        }

        // Render the box plot visualization
        function renderBoxPlot(sampleData) {
            visualDataSection.innerHTML = '';
            
            const plotDataForSelected = {};
            if (selectedSampleCode === 'all') {
                visualDataSection.innerHTML = `<p class="text-center text-gray-500">Box Plot은 특정 시료를 선택했을 때 표시됩니다.</p>`;
                return;
            } else {
                plotDataForSelected[selectedSampleCode] = sampleData[selectedSampleCode];
            }

            for (const sampleCode in plotDataForSelected) {
                const scores = plotDataForSelected[sampleCode].map(item => parseFloat(item.odorIntensity)).filter(v => !isNaN(v));
                
                if (scores.length === 0) {
                    visualDataSection.innerHTML = `<p class="text-center text-gray-500">선택된 시료에 대한 데이터가 없습니다.</p>`;
                    return;
                }
                const meanScore = scores.reduce((sum, current) => sum + current, 0) / scores.length;

                const plotData = [{
                    y: scores,
                    type: 'box',
                    name: `시료 코드: ${sampleCode}`,
                    boxpoints: 'all',
                    jitter: 0.3,
                    pointpos: -1.8,
                    marker: { color: 'rgb(84, 133, 222)' },
                    line: { color: 'rgb(84, 133, 222)' },
                }];

                const layout = {
                    title: `시료 코드 ${sampleCode} 냄새 강도 분포`,
                    yaxis: {
                        title: '냄새 강도 점수',
                        range: [7.0, 10.5],
                        autotick: false,
                        ticks: 'outside',
                        tick0: 7.0,
                        dtick: 0.5
                    },
                    shapes: [
                        { // Pass/Fail Line
                            type: 'line',
                            xref: 'paper',
                            x0: 0,
                            x1: 1,
                            yref: 'y',
                            y0: 9.5,
                            y1: 9.5,
                            line: {
                                color: 'rgb(255, 0, 0)',
                                width: 2,
                                dash: 'dot'
                            }
                        },
                        { // Mean Line
                            type: 'line',
                            xref: 'paper',
                            x0: 0,
                            x1: 1,
                            yref: 'y',
                            y0: meanScore,
                            y1: meanScore,
                            line: {
                                color: 'rgb(0, 150, 255)',
                                width: 2,
                                dash: 'dash'
                            }
                        }
                    ],
                    annotations: [
                        {
                            xref: 'paper',
                            yref: 'y',
                            x: 1,
                            y: 9.5,
                            text: 'Pass 기준',
                            showarrow: false,
                            xanchor: 'right',
                            yanchor: 'bottom',
                            bgcolor: 'rgba(255, 255, 255, 0.5)'
                        },
                        {
                            xref: 'paper',
                            yref: 'y',
                            x: 1,
                            y: meanScore,
                            text: `평균: ${meanScore.toFixed(2)}점`,
                            showarrow: false,
                            xanchor: 'right',
                            yanchor: 'bottom',
                            bgcolor: 'rgba(255, 255, 255, 0.5)'
                        }
                    ],
                    margin: { t: 40, b: 20, l: 40, r: 20 },
                    paper_bgcolor: 'rgb(248, 250, 252)',
                    plot_bgcolor: 'rgb(248, 250, 252)',
                    showlegend: false
                };

                const plotDiv = document.createElement('div');
                plotDiv.id = `boxplot-${sampleCode}`;
                plotDiv.className = "w-full";
                visualDataSection.appendChild(plotDiv);
                Plotly.newPlot(plotDiv.id, plotData, layout, {responsive: true});
            }
        }

        // Auto-update final evaluation based on Odor Intensity
        odorIntensityRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const score = parseFloat(e.target.value);
                const finalEvaluation = score >= 9.5 ? 'Pass' : 'Non-Pass';
                finalEvaluationDisplay.textContent = finalEvaluation;
                finalEvaluationDisplay.classList.remove('text-green-600', 'text-red-600', 'font-normal');
                finalEvaluationDisplay.classList.add(finalEvaluation === 'Pass' ? 'text-green-600' : 'text-red-600', 'font-semibold');
            });
        });
        
        // Handle form submission to save data
        evaluationForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const sampleCode = document.getElementById('sample-code').value.trim();
            const evaluator = document.getElementById('evaluator').value.trim();
            const evalPlace = document.getElementById('eval-place').value;
            const odorIntensity = document.querySelector('input[name="odor-intensity"]:checked')?.value;
            
            // Validation
            if (!sampleCode || !evaluator || !odorIntensity) {
                showMessage("시료 코드, 평가자, 냄새 강도 점수는 필수 입력 항목입니다.", false);
                return;
            }

            const finalEvaluation = parseFloat(odorIntensity) >= 9.5 ? 'Pass' : 'Non-Pass';

            // Check for duplicate evaluation
            const existingEvaluation = allEvaluations.find(evalItem => 
                evalItem.sampleCode === sampleCode && evalItem.evaluator === evaluator
            );

            if (existingEvaluation) {
                showConfirmModal(
                    "해당 평가자는 해당 시료코드에 대해 이미 평가를 하셨습니다. 기존 평가 정보를 갱신하시겠습니까?",
                    () => saveOrUpdateEvaluation(sampleCode, evaluator, evalPlace, odorIntensity, finalEvaluation, existingEvaluation.id),
                    () => showMessage("기록 갱신이 취소되었습니다.")
                );
            } else {
                saveOrUpdateEvaluation(sampleCode, evaluator, evalPlace, odorIntensity, finalEvaluation);
            }
        });

        // Function to save or update an evaluation
        async function saveOrUpdateEvaluation(sampleCode, evaluator, evalPlace, odorIntensity, finalEvaluation, docId = null) {
            const newEvaluation = {
                evalDate: document.getElementById('eval-date').value,
                timestamp: new Date().toISOString(),
                sampleCode: sampleCode,
                evaluator: evaluator,
                evalPlace: evalPlace,
                odorIntensity: odorIntensity,
                odorCharacteristic: document.getElementById('odor-characteristic').value.trim(),
                pleasantness: document.getElementById('pleasantness').value.trim(),
                remarks: document.getElementById('remarks').value.trim(),
                finalEvaluation: finalEvaluation
            };

            try {
                const evaluationsCollection = collection(db, `artifacts/${appId}/users/${userId}/evaluations`);
                const documentId = docId ? docId : `${sampleCode}_${evaluator}_${new Date().getTime()}`;
                const docRef = doc(evaluationsCollection, documentId);

                await setDoc(docRef, newEvaluation);
                showMessage(docId ? "평가 기록이 성공적으로 갱신되었습니다." : "평가 기록이 성공적으로 저장되었습니다.");
            } catch (error) {
                console.error("Error saving/updating evaluation:", error);
                showMessage("평가 기록 저장에 실패했습니다.", false);
            }
        }

        window.deleteEvaluation = async (docId) => {
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/evaluations`, docId);
            try {
                await deleteDoc(docRef);
                showMessage("평가 기록이 삭제되었습니다.");
            } catch (error) {
                console.error("Error deleting document:", error);
                showMessage("평가 기록 삭제에 실패했습니다.", false);
            }
        }

        // Add a global `fetch` wrapper for error handling
        window.originalFetch = window.fetch;
        window.fetch = async (url, options) => {
            try {
                const response = await window.originalFetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                console.error("Fetch failed:", error);
                showMessage("네트워크 오류가 발생했습니다. 다시 시도해주세요.", false);
                throw error;
            }
        };

        // PDF Generation
        downloadPdfButton.addEventListener('click', () => {
            if (!selectedEvaluation) {
                showMessage("PDF를 생성할 시료를 선택해주세요.", false);
                return;
            }
            if (!selectedApproval || !selectedApproval.approvals || !selectedApproval.approvals.quality_control) {
                showMessage("품질관리 책임자의 승인이 완료된 시료만 PDF로 다운로드할 수 있습니다.", false);
                return;
            }
            generatePdfReport(selectedEvaluation, selectedApproval);
        });

        async function generatePdfReport(evaluationData, approvalData) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Add Korean font
            doc.addFileToVFS('MalgunGothic.ttf', `
AAEAAAASAQAABAAwQ0ZGACi0p/4AAAI0AAAAWEdERUYAChmU8AAACRAAAAApT1MvMg8m6m8AAAXgAAAAYABgAGAAYABoP8g==
            `);
            doc.addFont('MalgunGothic.ttf', 'MalgunGothic', 'normal');
            doc.setFont('MalgunGothic');

            doc.text("종합평가 기록지", 20, 20);
            
            doc.setFontSize(10);
            doc.text(`시료 코드: ${evaluationData.sampleCode}`, 20, 30);
            
            const participants = evaluationData.evaluations.map(e => e.evaluator);
            const scores = evaluationData.evaluations.map(e => e.odorIntensity);
            
            const tableData = {
                head: [['구분', ...participants]],
                body: [['점수', ...scores]]
            };

            doc.autoTable({
                startY: 40,
                head: tableData.head,
                body: tableData.body,
                theme: 'grid',
                headStyles: { font: 'MalgunGothic', fontStyle: 'normal' },
                bodyStyles: { font: 'MalgunGothic', fontStyle: 'normal' },
            });

            const finalVerdictY = doc.autoTable.previous.finalY + 10;
            const averageScore = evaluationData.averageScore;
            const finalVerdict = averageScore >= 9.5 ? 'Pass' : 'Non-Pass';

            doc.text(`평균 점수: ${averageScore.toFixed(2)}점`, 20, finalVerdictY);
            doc.text(`최종 판정: ${finalVerdict}`, 20, finalVerdictY + 10);
            
            const approvalSectionY = finalVerdictY + 20;
            doc.text("확인", 20, approvalSectionY);
            doc.line(20, approvalSectionY + 2, 30, approvalSectionY + 2);

            const approvals = approvalData.approvals || {};
            let currentY = approvalSectionY + 10;
            const rolesForPdf = ['production', 'process', 'sales', 'quality_control'];

            for (const role of rolesForPdf) {
                const approval = approvals[role];
                if (approval) {
                    const nameText = `${managerNames[role]}: ${approval.name}`;
                    doc.text(nameText, 25, currentY);
                    
                    const signatureImg = new Image();
                    signatureImg.src = approval.signature;
                    doc.addImage(signatureImg, 'PNG', 100, currentY - 8, 30, 15);
                    currentY += 10;
                }
            }

            doc.save(`${evaluationData.sampleCode}_품질평가보고서.pdf`);
        }
        
        // Set default date to today and time
        document.getElementById('eval-date').value = new Date().toISOString().substring(0, 16);
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s forwards;
        }

        .animate-fadeOut {
            animation: fadeOut 0.3s forwards;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #signature-canvas {
            border: 1px solid #ccc;
            background-color: white;
            cursor: crosshair;
        }
    </style>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <nav class="w-64 bg-white shadow-xl p-6 space-y-4 flex flex-col items-start border-r border-gray-200">
        <div class="text-xl font-bold text-gray-800">메뉴</div>
        <button id="nav-evaluator" class="w-full text-left py-2 px-4 rounded-md text-gray-700 hover:bg-gray-200 transition-colors">
            평가자 페이지
        </button>
        <button id="nav-admin" class="w-full text-left py-2 px-4 rounded-md text-gray-700 hover:bg-gray-200 transition-colors">
            관리자 페이지
        </button>
        <p id="user-id" class="text-sm text-gray-400 mt-auto">User ID: Loading...</p>
    </nav>
    
    <!-- Main Content Area -->
    <div class="flex-1 p-8 overflow-y-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">제품 품질 평가</h1>
            <p class="text-gray-500 mt-2">개별 평가 기록 및 종합 시각화</p>
        </header>

        <!-- Evaluator Page -->
        <div id="evaluator-page" class="space-y-8">
            <section class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">개별 평가 기록지</h2>
                <form id="evaluation-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="eval-date" class="block text-sm font-medium text-gray-700">평가일시</label>
                            <input type="datetime-local" id="eval-date" name="eval-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="eval-place" class="block text-sm font-medium text-gray-700">평가 장소</label>
                            <select id="eval-place" name="eval-place" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="군산 실증 플랜트">군산 실증 플랜트</option>
                                <option value="대전 기술연구소">대전 기술연구소</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                        <div>
                            <label for="sample-code" class="block text-sm font-medium text-gray-700">시료 코드</label>
                            <input type="text" id="sample-code" name="sample-code" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="evaluator" class="block text-sm font-medium text-gray-700">평가자</label>
                            <input type="text" id="evaluator" name="evaluator" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                    </div>
    
                    <!-- Odor Intensity -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">냄새 강도</label>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4">
                            <div class="flex items-center">
                                <input id="odor-10" name="odor-intensity" type="radio" value="10.0" class="h-4 w-4 text-indigo-600 border-gray-300 rounded-full focus:ring-indigo-500">
                                <label for="odor-10" class="ml-2 text-sm text-gray-700">10.0 (무취)</label>
                            </div>
                            <div class="flex items-center">
                                <input id="odor-9.5" name="odor-intensity" type="radio" value="9.5" class="h-4 w-4 text-indigo-600 border-gray-300 rounded-full focus:ring-indigo-500">
                                <label for="odor-9.5" class="ml-2 text-sm text-gray-700">9.5 (매우 미미)</label>
                            </div>
                            <div class="flex items-center">
                                <input id="odor-9" name="odor-intensity" type="radio" value="9.0" class="h-4 w-4 text-indigo-600 border-gray-300 rounded-full focus:ring-indigo-500">
                                <label for="odor-9" class="ml-2 text-sm text-gray-700">9.0 (미미)</label>
                            </div>
                            <div class="flex items-center">
                                <input id="odor-8.5" name="odor-intensity" type="radio" value="8.5" class="h-4 w-4 text-indigo-600 border-gray-300 rounded-full focus:ring-indigo-500">
                                <label for="odor-8.5" class="ml-2 text-sm text-gray-700">8.5 (약함)</label>
                            </div>
                            <div class="flex items-center">
                                <input id="odor-8" name="odor-intensity" type="radio" value="8.0" class="h-4 w-4 text-indigo-600 border-gray-300 rounded-full focus:ring-indigo-500">
                                <label for="odor-8" class="ml-2 text-sm text-gray-700">8.0 (감지 가능)</label>
                            </div>
                            <div class="flex items-center">
                                <input id="odor-7.5" name="odor-intensity" type="radio" value="7.5" class="h-4 w-4 text-indigo-600 border-gray-300 rounded-full focus:ring-indigo-500">
                                <label for="odor-7.5" class="ml-2 text-sm text-gray-700">7.5 이하 (강함)</label>
                            </div>
                        </div>
                    </div>
    
                    <div>
                        <label for="odor-characteristic" class="block text-sm font-medium text-gray-700">냄새 특성</label>
                        <textarea id="odor-characteristic" name="odor-characteristic" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예시: 구수한 향, 시큼한 향, 요거트 향, 알콜 향 등"></textarea>
                    </div>
                    <div>
                        <label for="pleasantness" class="block text-sm font-medium text-gray-700">쾌적도</label>
                        <textarea id="pleasantness" name="pleasantness" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예시: 불쾌함, 자극적임, 향기로움, 역겨움 등"></textarea>
                    </div>
                    <div>
                        <label for="remarks" class="block text-sm font-medium text-gray-700">기타 특이사항</label>
                        <textarea id="remarks" name="remarks" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예시: 조업 또는 관능 평가 중 특이사항을 기재 바랍니다."></textarea>
                    </div>
    
                    <!-- Final Evaluation -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">최종 평가</label>
                        <div class="flex items-center space-x-4">
                            <span id="final-evaluation-display" class="font-normal text-gray-500">냄새 강도를 선택하세요</span>
                        </div>
                    </div>
    
                    <div class="flex justify-end items-center gap-4">
                        <div id="message-box" class="hidden px-4 py-2 rounded-md text-white transition-all duration-300"></div>
                        <button type="submit" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 transition-colors">기록 저장</button>
                    </div>
                </form>
            </section>
        </div>

        <!-- Admin Page -->
        <div id="admin-page" class="hidden space-y-8">
            <!-- Approval Section -->
            <section class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">품질 평가 승인</h2>
                <div class="flex justify-between items-end mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                        <div>
                            <label for="sample-code-filter" class="block text-sm font-medium text-gray-700">승인할 시료 코드 선택</label>
                            <select id="sample-code-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                    </div>
                    <button id="download-pdf-button" class="hidden px-4 py-2 bg-red-600 text-white font-semibold rounded-md shadow-md hover:bg-red-700 transition-colors">
                        PDF 보고서 다운로드
                    </button>
                </div>
                
                <!-- Approval UI -->
                <div id="approval-section" class="mt-6 p-4 rounded-lg border border-gray-300 bg-white hidden">
                    <h3 class="text-lg font-bold text-gray-800">
                        <span id="approval-sample-code" class="text-indigo-600"></span>
                        시료 승인 상태
                    </h3>
                    <p class="mt-2 text-sm text-gray-500">최종 평가: <span id="approval-final-status" class="font-semibold"></span></p>
                    <div id="approval-buttons" class="mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                        <!-- Approval buttons will be rendered here -->
                    </div>
                </div>
            </section>
            
            <!-- Evaluation Table -->
            <section class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">평가 기록 테이블</h2>
                <div class="overflow-x-auto rounded-lg">
                    <table class="min-w-full bg-white border-collapse">
                        <thead>
                            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">평가일</th>
                                <th class="py-3 px-6 text-left">평가 장소</th>
                                <th class="py-3 px-6 text-left">시료 코드</th>
                                <th class="py-3 px-6 text-left">평가자</th>
                                <th class="py-3 px-6 text-left">냄새 강도</th>
                                <th class="py-3 px-6 text-left">냄새 특성</th>
                                <th class="py-3 px-6 text-left">쾌적도</th>
                                <th class="py-3 px-6 text-left">기타</th>
                                <th class="py-3 px-6 text-left">최종 평가</th>
                                <th class="py-3 px-6 text-left">관리</th>
                            </tr>
                        </thead>
                        <tbody id="evaluation-table-body" class="text-gray-600 text-sm font-light">
                            <!-- Data will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </section>
    
            <!-- Data Visualization Section -->
            <section class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">데이터 시각화 (Box Plot)</h2>
                <div id="visual-data" class="flex flex-wrap justify-center items-center space-x-4">
                    <!-- Plots will be dynamically inserted here -->
                </div>
            </section>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">확인</h3>
            <p id="confirm-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-yes-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">예</button>
                <button id="confirm-no-btn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">아니요</button>
            </div>
        </div>
    </div>

    <!-- Approval Modal -->
    <div id="approval-modal" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm relative">
            <button id="modal-close-btn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
            <h3 class="text-xl font-bold mb-4"><span id="current-role-display"></span> 승인</h3>
            <div class="mb-4">
                <label for="signature-name" class="block text-sm font-medium text-gray-700">이름</label>
                <input type="text" id="signature-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">전자 서명</label>
                <canvas id="signature-canvas" width="300" height="100" class="rounded-md border-2 border-gray-300 mt-1"></canvas>
            </div>
            <div class="flex justify-between items-center">
                <button id="signature-clear-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">지우기</button>
                <button id="signature-save-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">승인하기</button>
            </div>
        </div>
    </div>
</body>
</html>

